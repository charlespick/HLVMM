#cloud-config

# 1. Write the main provisioning script to disk
write_files:
  - path: /usr/local/bin/provisioning-service.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!!! Build system put provisioning-service.sh content here !!!#

# 2. Write module files
  - path: /usr/local/bin/modules/mod_general.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!!! Build system put mod_general.sh content here !!!#

  - path: /usr/local/bin/modules/mod_net.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!!! Build system put mod_net.sh content here !!!#

  - path: /usr/local/bin/modules/mod_domain.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!!! Build system put mod_domain.sh content here !!!#

  - path: /usr/local/bin/modules/mod_ansible.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!!! Build system put mod_ansible.sh content here !!!#

# 3. Write the systemd service unit
  - path: /etc/systemd/system/provisioning.service
    permissions: '0644'
    owner: root:root
    content: |
      [Unit]
      Description=Provisioning Service
      After=network.target

      [Service]
      Type=simple
      ExecStart=/usr/local/bin/provisioning-service.sh
      Restart=on-failure
      User=root

      [Install]
      WantedBy=multi-user.target

# 4. Start provisioning service
runcmd:
  # Wait a moment for KVP daemon to initialize
  - sleep 5
  - systemctl daemon-reload
  - systemctl enable provisioning.service
  - systemctl start provisioning.service