name: Version Bump, Build and Release

# Triggering a build

on:
  push:
    branches:
      - main
      - devel
  pull_request:
    branches:
      - main
      - devel

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    # VERSION BUMP LOGIC (only for pushes to main/devel)
    - name: Check if version file was changed
      if: github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'devel')
      id: version_check
      run: |
        git diff-tree --no-commit-id --name-only -r ${{ github.sha }} > files_changed.txt
        if grep -q "^version$" files_changed.txt; then
          echo "skip_bump=true" >> $GITHUB_OUTPUT
          echo "Version file was already changed in this commit, skipping bump"
        else
          echo "skip_bump=false" >> $GITHUB_OUTPUT
          echo "Version file not changed, will bump version"
        fi
        
    - name: Read current version
      if: github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'devel') && steps.version_check.outputs.skip_bump == 'false'
      id: read_version
      run: |
        version=$(cat version)
        echo "current=$version" >> $GITHUB_OUTPUT
        echo "Current version: $version"

    - name: Increment version
      if: github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'devel') && steps.version_check.outputs.skip_bump == 'false'
      id: bump_version
      run: |
        ver=${{ steps.read_version.outputs.current }}
        IFS='.' read -r major minor build <<< "$ver"
        build=$(printf "%03d" $((10#$build + 1))) # force decimal, keep leading zeros
        new_ver="$major.$minor.$build"
        echo "$new_ver" > version
        echo "new=$new_ver" >> $GITHUB_OUTPUT
        echo "Bumped version to: $new_ver"

    - name: Commit new version
      if: github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'devel') && steps.version_check.outputs.skip_bump == 'false'
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add version
        git commit -m "ci: bump version to ${{ steps.bump_version.outputs.new }}"
        git push
        echo "Version bump committed and pushed"
        
    # BUILD LOGIC (runs for all events after version bump if needed)
    - name: Install ISO creation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y xorriso genisoimage
        
    - name: Build ISOs
      run: |
        pwsh Scripts/Build-ProvisioningISOs.ps1
        
    - name: List created ISOs
      run: |
        echo "Created ISOs:"
        ls -la ISOs/
        
    # RELEASE LOGIC
    - name: Determine release strategy
      id: release_info
      run: |
        if [[ "${{ github.ref_name }}" == "main" ]]; then
          echo "create_standard_release=true" >> $GITHUB_OUTPUT
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref_name }}" == "devel" ]]; then
          echo "create_standard_release=true" >> $GITHUB_OUTPUT
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
        else
          echo "create_standard_release=false" >> $GITHUB_OUTPUT
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
        fi
        
    # CREATE RELEASES (both main and devel branches)
    - name: Create release
      if: github.event_name == 'push' && steps.release_info.outputs.create_standard_release == 'true'
      run: |
        # Get version from version file (now contains the bumped version)
        VERSION_CONTENT=""
        if [ -f "version" ]; then
          VERSION_CONTENT=$(cat version)
        fi
        
        # Determine tag and release names based on branch
        if [[ "${{ github.ref_name }}" == "main" ]]; then
          TAG_NAME="v${VERSION_CONTENT}"
          RELEASE_TITLE="Release ${VERSION_CONTENT}"
          RELEASE_TYPE="stable"
        else
          # For devel branch, create prerelease with timestamp
          TIMESTAMP=$(date -u '+%Y%m%d-%H%M%S')
          TAG_NAME="v${VERSION_CONTENT}-devel-${TIMESTAMP}"
          RELEASE_TITLE="Development Build v${VERSION_CONTENT}-devel-${TIMESTAMP}"
          RELEASE_TYPE="prerelease"
        fi
        
        # Create release notes
        if [[ "${{ github.ref_name }}" == "main" ]]; then
          cat << EOF > release_notes.md
        ## Release ${VERSION_CONTENT} - $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        **Branch:** \`${{ github.ref_name }}\`
        **Commit:** \`${{ github.sha }}\`
        **Version:** \`${VERSION_CONTENT}\`
        
        ### Artifacts
        - **WindowsProvisioning.iso** - Provisioning ISO for Windows systems
        - **LinuxProvisioning.iso** - Provisioning ISO for Linux systems (cloud-init compatible)
        
        ### Build Information
        - Built on: Ubuntu Latest
        - ISO Tools: xorriso, genisoimage
        - Workflow: ${{ github.workflow }}
        - Run: #${{ github.run_number }}
        
        ### Download URLs
        These artifacts are available at stable URLs:
        - Windows ISO: \`https://github.com/${{ github.repository }}/releases/latest/download/WindowsProvisioning.iso\`
        - Linux ISO: \`https://github.com/${{ github.repository }}/releases/latest/download/LinuxProvisioning.iso\`
        EOF
        else
          cat << EOF > release_notes.md
        ## Development Build v${VERSION_CONTENT}-devel-${TIMESTAMP}
        
        **‚ö†Ô∏è This is a prerelease development build - use with caution**
        
        **Branch:** \`${{ github.ref_name }}\`
        **Commit:** \`${{ github.sha }}\`
        **Version:** \`${VERSION_CONTENT}\`
        **Build:** #${{ github.run_number }}
        **Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        ### Artifacts
        - **WindowsProvisioning.iso** - Provisioning ISO for Windows systems
        - **LinuxProvisioning.iso** - Provisioning ISO for Linux systems (cloud-init compatible)
        
        ### Build Information
        - Built on: Ubuntu Latest
        - ISO Tools: xorriso, genisoimage
        - Workflow: ${{ github.workflow }}
        - Run: #${{ github.run_number }}
        
        ### Usage with InstallHostProvisioningISOs.ps1
        This prerelease will be automatically detected by the \`-Develop\` switch when using the latest version of the install script.
        EOF
        fi
        
        # Create the release
        RELEASE_FLAGS=""
        if [[ "${{ steps.release_info.outputs.is_prerelease }}" == "true" ]]; then
          RELEASE_FLAGS="--prerelease"
        fi
        
        gh release create "$TAG_NAME" \
          --title "$RELEASE_TITLE" \
          --notes-file release_notes.md \
          $RELEASE_FLAGS \
          ISOs/WindowsProvisioning.iso \
          ISOs/LinuxProvisioning.iso
          
        echo "Created $RELEASE_TYPE release: $TAG_NAME"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts for PR builds
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: provisioning-isos-pr-${{ github.event.number }}
        path: |
          ISOs/WindowsProvisioning.iso
          ISOs/LinuxProvisioning.iso
        retention-days: 7
        
    - name: Comment on PR with download links
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const runId = context.runId;
          const prNumber = context.issue.number;
          
          // Get the actual commit SHA for PRs
          const commitSha = context.payload.pull_request.head.sha;
          
          // Get version for PR comment
          const fs = require('fs');
          let version = 'unknown';
          try {
            version = fs.readFileSync('version', 'utf8').trim();
          } catch (e) {
            console.log('Could not read version file');
          }
          
          const comment = `## üî® Build Completed Successfully!
          
          The provisioning ISOs have been built and are available as artifacts.
          
          **Download Links:**
          - [Download Build Artifacts](https://github.com/${{ github.repository }}/actions/runs/${runId})
          
          **Artifacts:**
          - \`WindowsProvisioning.iso\` - Provisioning ISO for Windows systems
          - \`LinuxProvisioning.iso\` - Provisioning ISO for Linux systems (cloud-init compatible)
          
          **Build Details:**
          - Version: \`${version}\`
          - Commit: \`${commitSha}\`
          - Branch: \`${{ github.head_ref }}\`
          - Workflow Run: #${{ github.run_number }}
          
          Artifacts will be retained for 7 days.`;
          
          github.rest.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });