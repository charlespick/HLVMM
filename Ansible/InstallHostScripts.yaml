---
- name: Download and execute PowerShell script
  hosts: hyperv_hosts
  tasks:
    - name: Ensure C:\Temp exists
      win_file:
        path: C:\Temp
        state: directory
    - name: Delete old version of script
      win_file:
        path: C:\Temp\InstallHostScripts.ps1
        state: absent
    - name: Download the PowerShell script
      changed_when: false
      win_get_url:
        url: https://raw.githubusercontent.com/charlespick/HLVMM/refs/heads/main/Scripts/InstallHostScripts.ps1
        dest: C:\Temp\InstallHostScripts.ps1

    - name: Execute the PowerShell script
      win_shell: |
        powershell.exe -ExecutionPolicy Bypass -File C:\Temp\InstallHostScripts.ps1
      register: script_result
      changed_when: "'Update complete.' in script_result.stdout"
      failed_when:
        - "'Update complete.' not in script_result.stdout"
        - "'No update needed. Local version is up-to-date.' not in script_result.stdout"
