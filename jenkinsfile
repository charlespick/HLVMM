pipeline {
    agent {
        label 'windows'
    }

    parameters {
        string(name: 'AWS_REGION', defaultValue: 'us-east-1', description: 'AWS Region to use')
        string(name: 'S3_BUCKET', defaultValue: 'my-bucket-name', description: 'S3 bucket for uploads')
        string(name: 'S3_PREFIX', defaultValue: 'builds', description: 'S3 path/prefix for artifacts')
    }

    environment {
        AWS_CREDS = credentials('jenkins-vmm-isos-upload')
        AWS_ACCESS_KEY_ID     = "${env.AWS_CREDS_USR}"
        AWS_SECRET_ACCESS_KEY = "${env.AWS_CREDS_PSW}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build ISOs') {
            steps {
                powershell '''
                    # Run the script in scripts folder
                    $scriptPath = Join-Path $env:WORKSPACE "scripts\\MakeProvisioningISOs.ps1"
                    & $scriptPath
                '''
            }
        }

        stage('Upload to S3') {
            steps {
                withEnv(["PATH+AWSCLI=C:\\Program Files\\Amazon\\AWSCLIV2"]) {
                    powershell '''
                        $isoDir = Join-Path $env:WORKSPACE "ISOs"

                        $dest = "s3://$env:S3_BUCKET/$env:S3_PREFIX/"

                        aws s3 cp "$isoDir\\WindowsProvisioning.iso" $dest
                        aws s3 cp "$isoDir\\LinuxProvisioning.iso" $dest
                    '''
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'ISOs/*.iso', fingerprint: true
        }
    }
}
